у{% extends "base.html" %}
{% load static %}

{% block title %}Редактирование вакансии{% endblock %}
{% block description %}Редактирование вакансии "{{ vacancy.title }}"{% endblock %}

{% block page_header %}
<!-- Блок с градиентом и заголовком -->
<div class="task-header-gradient">
    <div class="container">
        <div class="text-center text-white">
            <h1 class="display-5 fw-bold mb-3">Редактирование вакансии</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb justify-content-center mb-0 breadcrumb-header">
                    <li class="breadcrumb-item">
                        <a href="{% url 'home' %}" class="text-white text-decoration-none">Главная</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'vacancies:vacancy_list' %}" class="text-white text-decoration-none">Вакансии</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'vacancies:vacancy_detail' vacancy.slug %}" class="text-white text-decoration-none">{{ vacancy.title|truncatewords:3 }}</a>
                    </li>
                    <li class="breadcrumb-item active text-white" aria-current="page">Редактирование</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-pencil me-2"></i>Редактирование вакансии "{{ vacancy.title }}"
                </h5>
            </div>
            <div class="card-body">
                {% if vacancy.is_moderated %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Внимание!</strong> После редактирования вакансия будет отправлена на повторную модерацию.
                    </div>
                {% endif %}
                
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">
                                {{ form.title.label }} *
                            </label>
                            {{ form.title }}
                            {% if form.title.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.title.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.specialty.id_for_label }}" class="form-label">
                                {{ form.specialty.label }} *
                            </label>
                            {{ form.specialty }}
                            {% if form.specialty.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.specialty.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.salary.id_for_label }}" class="form-label">
                                {{ form.salary.label }} *
                            </label>
                            {{ form.salary }}
                            {% if form.salary.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.salary.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if form.salary.help_text %}
                                <div class="form-text">{{ form.salary.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.experience.id_for_label }}" class="form-label">
                                {{ form.experience.label }} *
                            </label>
                            {{ form.experience }}
                            {% if form.experience.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.experience.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.employment_type.id_for_label }}" class="form-label">
                                {{ form.employment_type.label }} *
                            </label>
                            {{ form.employment_type }}
                            {% if form.employment_type.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.employment_type.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                         <div class="col-md-6 mb-3">
                            <label for="{{ form.region.id_for_label }}" class="form-label">
                                {{ form.region.label }}
                            </label>
                            {{ form.region }}
                            {% if form.region.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.region.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if form.region.help_text %}
                                <div class="form-text">{{ form.region.help_text }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.city.id_for_label }}" class="form-label">
                                {{ form.city.label }}
                            </label>
                            {{ form.city }}
                            {% if form.city.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.city.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if form.city.help_text %}
                                <div class="form-text">{{ form.city.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.work_nature.id_for_label }}" class="form-label">
                                {{ form.work_nature.label }} *
                            </label>
                            {{ form.work_nature }}
                            {% if form.work_nature.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.work_nature.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.location.id_for_label }}" class="form-label">
                                {{ form.location.label }}
                            </label>
                            {{ form.location }}
                            {% if form.location.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.location.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if form.location.help_text %}
                                <div class="form-text">{{ form.location.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            {{ form.description.label }} *
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.other_conditions.id_for_label }}" class="form-label">
                            {{ form.other_conditions.label }}
                        </label>
                        {{ form.other_conditions }}
                        {% if form.other_conditions.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.other_conditions.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if form.other_conditions.help_text %}
                            <div class="form-text">{{ form.other_conditions.help_text }}</div>
                        {% endif %}
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'vacancies:vacancy_detail' vacancy.slug %}" class="btn btn-secondary me-md-2">
                            <i class="bi bi-arrow-left me-1"></i>Отмена
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>Сохранить изменения
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div style="height: 50px;"></div>
{% endblock %}

{% block extra_css %}
<style>
.form-control, .form-select {
    border-radius: 0.375rem;
    padding: 0.75rem;
    border: 1px solid #ced4da;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

label.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.card {
    border: none;
    border-radius: 0.5rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Динамическая загрузка городов по региону
    const regionField = document.getElementById('id_region');
    const cityField = document.getElementById('id_city');
    const cityUrl = '{% url "vacancies:get_cities_by_region" %}';
    
    // Сохраняем выбранный город при редактировании
    const selectedCityId = cityField ? cityField.value : null;

    function loadCities(regionId, preserveCity = false) {
        if (!regionId || !cityField) {
            if (cityField) {
                cityField.innerHTML = '<option value="">Сначала выберите регион</option>';
                cityField.disabled = true;
            }
            return;
        }

        cityField.disabled = true;
        cityField.innerHTML = '<option value="">Загрузка...</option>';

        fetch(`${cityUrl}?region_id=${regionId}`)
            .then(response => response.json())
            .then(data => {
                cityField.innerHTML = '<option value="">Выберите город</option>';
                
                if (data.cities && data.cities.length > 0) {
                    data.cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.id;
                        option.textContent = city.name;
                        // Если сохраняем город (при редактировании), устанавливаем его как выбранный
                        if (preserveCity && selectedCityId && String(city.id) === String(selectedCityId)) {
                            option.selected = true;
                        }
                        cityField.appendChild(option);
                    });
                    cityField.disabled = false;
                } else {
                    cityField.innerHTML = '<option value="">Нет доступных городов</option>';
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке городов:', error);
                cityField.innerHTML = '<option value="">Ошибка загрузки</option>';
            });
    }

    // Обработчик изменения региона
    if (regionField) {
        regionField.addEventListener('change', function() {
            loadCities(this.value, false);
            // Сбрасываем выбранный город при смене региона
            if (cityField) cityField.value = '';
        });

        // Если регион уже выбран (при редактировании), загружаем города с сохранением выбранного
        if (regionField.value) {
            loadCities(regionField.value, true);
        } else if (cityField) {
            cityField.disabled = true;
        }
    }
});
</script>
{% endblock %}