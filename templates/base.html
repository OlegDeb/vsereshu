{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}–ú–æ–π –ø—Ä–æ–µ–∫—Ç{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="{% static "css/style.css" %}" rel="stylesheet">
    <style>
        /* Sticky footer - –ø—Ä–∏–∂–∏–º–∞–µ—Ç —Ñ—É—Ç–µ—Ä –∫ –Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        html, body {
            height: 100%;
        }
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .main-content-wrapper {
            flex: 1 0 auto;
            display: flex;
            flex-direction: column;
            padding-top: 76px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –Ω–∞–≤–±–∞—Ä–∞ */
        }
        /* –î–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü —Å page_header —É–±–∏—Ä–∞–µ–º padding-top, —Ç–∞–∫ –∫–∞–∫ header —É–∂–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–∞–≤–±–∞—Ä */
        .main-content-wrapper > .task-header-gradient {
            margin-top: -76px; /* –ö–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ–º padding-top –æ–±–µ—Ä—Ç–∫–∏ */
        }
        footer {
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–µ—Ä—Ö–Ω–µ–µ –º–µ–Ω—é -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center w-100">
                <!-- –õ–æ–≥–æ—Ç–∏–ø —Å–ª–µ–≤–∞ -->
                <a class="navbar-brand" href="{% url 'home' %}">
                    <img src="{% static 'img/logo/logo.png' %}" alt="–í–°–Å-–†–ï–®–£" class="navbar-logo">
                </a>
                
                <!-- –ú–µ–Ω—é –ø–æ —Ü–µ–Ω—Ç—Ä—É (–¥–µ—Å–∫—Ç–æ–ø) / –ë—É—Ä–≥–µ—Ä –ø–æ —Ü–µ–Ω—Ç—Ä—É (–º–æ–±–∏–ª—å–Ω—ã–µ) -->
                <div class="d-flex align-items-center navbar-center">
                    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ -->
                    <div class="d-none d-lg-flex">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'home' %}">–ì–ª–∞–≤–Ω–∞—è</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.resolver_match.namespace == 'tasks' %}active{% endif %}" href="{% url 'tasks:task_list' %}">–ó–∞–¥–∞—á–∏</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.resolver_match.namespace == 'services' %}active{% endif %}" href="{% url 'services:service_list' %}">–£—Å–ª—É–≥–∏</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.resolver_match.namespace == 'pages' %}active{% endif %}" href="{% url 'pages:page_list' %}">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link {% if request.resolver_match.namespace == 'articles' %}active{% endif %}" href="{% url 'articles:article_list' %}">–°—Ç–∞—Ç—å–∏</a>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- –ë—É—Ä–≥–µ—Ä-–º–µ–Ω—é –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
                    <button class="navbar-toggler d-lg-none ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" style="border: none; padding: 0.5rem;">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                </div>
                
                <!-- –ë–ª–æ–∫ —Å –∏–∫–æ–Ω–∫–∞–º–∏ —Å–ø—Ä–∞–≤–∞ -->
                <div class="d-flex align-items-center gap-2">
                    {% if user.is_authenticated %}
                        <!-- –ò–∫–æ–Ω–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–æ —Å—á–µ—Ç—á–∏–∫–æ–º -->
                        <div class="nav-item">
                            <a class="nav-link position-relative" href="{% url 'users:notifications' %}" style="padding: 0.5rem 0.75rem;">
                                <i class="bi bi-bell fs-5"></i>
                                {% if unread_notifications_count > 0 %}
                                    <span class="position-absolute badge rounded-pill bg-warning" id="notifications-badge" style="top: 2px; right: -5px; color: #000;">
                                        {{ unread_notifications_count }}
                                        {% if unread_notifications_count > 99 %}
                                            <span class="visually-hidden">99+</span>
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </a>
                        </div>
                        <!-- –ò–∫–æ–Ω–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ —Å—á–µ—Ç—á–∏–∫–æ–º -->
                        <div class="nav-item dropdown">
                            <a class="nav-link position-relative" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="padding: 0.5rem 0.75rem;">
                                <i class="bi bi-envelope fs-5"></i>
                                {% if unread_messages_count > 0 %}
                                    <span class="position-absolute badge rounded-pill bg-danger" id="messages-badge" style="top: 2px; right: -5px;">
                                        {{ unread_messages_count }}
                                        {% if unread_messages_count > 99 %}
                                            <span class="visually-hidden">99+</span>
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end messages-dropdown" style="min-width: 320px; max-height: 500px; overflow-y: auto;">
                                <li>
                                    <h6 class="dropdown-header d-flex justify-content-between align-items-center">
                                        <span>–°–æ–æ–±—â–µ–Ω–∏—è</span>
                                        {% if unread_messages_count > 0 %}
                                            <span class="badge bg-danger rounded-pill">{{ unread_messages_count }}</span>
                                        {% endif %}
                                    </h6>
                                </li>
                                {% if unread_messages_list %}
                                    {% for msg_info in unread_messages_list %}
                                        <li>
                                            <a class="dropdown-item messages-dropdown-item" href="{{ msg_info.url }}">
                                                <div class="d-flex align-items-start">
                                                    <div class="flex-shrink-0 me-2">
                                                        {% if msg_info.other_user.avatar %}
                                                            <img src="{{ msg_info.other_user.avatar.url }}" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;" alt="{{ msg_info.other_user.username }}">
                                                        {% else %}
                                                            <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                                <span class="text-white small">{{ msg_info.other_user.username|first|upper }}</span>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                                            <strong class="text-truncate" style="max-width: 150px;">{{ msg_info.other_user.get_full_name|default:msg_info.other_user.username }}</strong>
                                                            {% if msg_info.unread_count > 1 %}
                                                                <span class="badge bg-danger rounded-pill ms-2">{{ msg_info.unread_count }}</span>
                                                            {% endif %}
                                                        </div>
                                                        <div class="text-muted small mb-1">
                                                            {% if msg_info.type == 'task' %}
                                                                <i class="bi bi-check2-square me-1"></i>{{ msg_info.task.title|truncatewords:8 }}
                                                            {% else %}
                                                                <i class="bi bi-briefcase me-1"></i>{{ msg_info.service.title|truncatewords:8 }}
                                                            {% endif %}
                                                        </div>
                                                        <div class="text-muted small text-truncate" style="max-width: 200px;">
                                                            {{ msg_info.last_message.content|truncatewords:10 }}
                                                        </div>
                                                        <div class="text-muted small mt-1">
                                                            {{ msg_info.last_message.created_at|timesince }} –Ω–∞–∑–∞–¥
                                                        </div>
                                                    </div>
                                                </div>
                                            </a>
                                        </li>
                                        {% if not forloop.last %}
                                            <li><hr class="dropdown-divider my-1"></li>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <li>
                                        <a class="dropdown-item text-center text-muted py-3">
                                            <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                                            <small>–ù–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</small>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </div>
                        
                        <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" style="padding: 0.5rem 1rem;">
                                {% if user.avatar %}
                                    <img src="{{ user.avatar.url }}" class="navbar-avatar rounded-circle me-1 me-md-2" alt="–ê–≤–∞—Ç–∞—Ä">
                                {% else %}
                                    <div class="navbar-avatar rounded-circle bg-secondary d-flex align-items-center justify-content-center me-1 me-md-2">
                                        <span class="text-white small">{{ user.username|first|upper }}</span>
                                    </div>
                                {% endif %}
                                <span class="d-none d-md-inline">–ü—Ä–∏–≤–µ—Ç, {{ user.username }}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="{% url 'tasks:create_task' %}">
                                        ‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'services:create_service' %}">
                                        ‚ûï –°–æ–∑–¥–∞—Ç—å —É—Å–ª—É–≥—É
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'users:profile' %}">
                                        üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'users:profile_edit' %}">
                                        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                                    </a>
                                </li>
                                {% if user.is_staff %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-warning" href="{% url 'users:moderation_panel' %}">
                                        üõ°Ô∏è –ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                                    </a>
                                </li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="{% url 'users:logout' %}">
                                        üö™ –í—ã–π—Ç–∏
                                    </a>
                                </li>
                            </ul>
                        </div>
                    {% else %}
                        <!-- –ú–µ–Ω—é –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                        <div class="d-flex align-items-center">
                            <a class="nav-link" href="{% url 'users:login' %}">–í—Ö–æ–¥</a>
                            <a class="nav-link" href="{% url 'users:register' %}" style="margin-left: 10px !important;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ –∫–ª–∏–∫—É –Ω–∞ –±—É—Ä–≥–µ—Ä) -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav d-lg-none">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'home' %}">–ì–ª–∞–≤–Ω–∞—è</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.namespace == 'tasks' %}active{% endif %}" href="{% url 'tasks:task_list' %}">–ó–∞–¥–∞—á–∏</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.namespace == 'services' %}active{% endif %}" href="{% url 'services:service_list' %}">–£—Å–ª—É–≥–∏</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.namespace == 'pages' %}active{% endif %}" href="{% url 'pages:page_list' %}">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.namespace == 'articles' %}active{% endif %}" href="{% url 'articles:article_list' %}">–°—Ç–∞—Ç—å–∏</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
    <div class="main-content-wrapper">
        <!-- –ë–ª–æ–∫ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º (–¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –∫—Ä–æ–º–µ –≥–ª–∞–≤–Ω–æ–π) -->
        {% block page_header %}
        {% endblock %}

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="container mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}
        {% endblock %}
        </div>
    </div>

    <!-- –§—É—Ç–µ—Ä -->
    <footer class="bg-light pt-5 pb-3">
        <div class="container">
            <div class="row mb-4">
                <!-- –ë–ª–æ–∫ —Å –≥–æ—Ä–æ–¥–∞–º–∏ -->
                {% if footer_cities %}
                <div class="col-md-4 mb-4 mb-md-0">
                    <h5 class="fw-bold mb-3" style="color: #003366;">–ì–æ—Ä–æ–¥–∞</h5>
                    <ul class="list-unstyled">
                        {% for city in footer_cities %}
                        <li class="mb-2">
                            <a href="{% url 'tasks:task_list' %}?city={{ city.id }}" class="text-decoration-none text-muted">
                                <i class="bi bi-geo-alt me-2"></i>{{ city.name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% if footer_cities|length >= 10 %}
                    <a href="{% url 'tasks:task_list' %}" class="text-decoration-none text-primary small">
                        –í—Å–µ –≥–æ—Ä–æ–¥–∞ <i class="bi bi-arrow-right"></i>
                    </a>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- –ë–ª–æ–∫ —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏ -->
                {% if footer_sections %}
                <div class="col-md-4 mb-4 mb-md-0">
                    <h5 class="fw-bold mb-3" style="color: #003366;">–†–∞–∑–¥–µ–ª—ã</h5>
                    <ul class="list-unstyled">
                        {% for section in footer_sections %}
                        <li class="mb-2">
                            <div class="d-flex align-items-center">
                                {% if section.icon %}
                                <i class="{{ section.icon }} me-2 text-primary"></i>
                                {% endif %}
                                <a href="{% url 'tasks:task_list' %}?section={{ section.slug }}" class="text-decoration-none text-muted">
                                    <strong>{{ section.name }}</strong>
                                </a>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- –ë–ª–æ–∫ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ —Å—Ç–∞—Ç—å—è–º–∏ -->
                {% if footer_articles %}
                <div class="col-md-4">
                    <h5 class="fw-bold mb-3" style="color: #003366;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç–∞—Ç—å–∏</h5>
                    <ul class="list-unstyled">
                        {% for article in footer_articles %}
                        <li class="mb-2">
                            <a href="{% url 'articles:article_detail' article.slug %}" class="text-decoration-none">
                                <span class="text-muted">{{ article.title|truncatewords:10 }}</span>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                    <a href="{% url 'articles:article_list' %}" class="text-decoration-none text-primary small">
                        –í—Å–µ —Å—Ç–∞—Ç—å–∏ <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
                {% endif %}
            </div>
            
            <!-- –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å —Ñ—É—Ç–µ—Ä–∞ -->
            <hr class="my-4">
            <div class="row align-items-center">
                <div class="col-md-6 mb-2 mb-md-0">
                    <p class="text-muted small mb-0">
                        &copy; {% now "Y" %} –í–°–Å-–†–ï–®–£. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <a href="/info/politika-konfidencialnosti/" class="text-decoration-none text-muted small me-3">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
                    <a href="/info/publichnaya-oferta/" class="text-decoration-none text-muted small">–ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>