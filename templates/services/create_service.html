{% extends "base.html" %}

{% block title %}{% if is_edit %}Редактировать услугу{% else %}Создать услугу{% endif %}{% endblock %}

{% block page_header %}
<!-- Блок с градиентом и заголовком -->
<div class="task-header-gradient">
    <div class="container">
        <div class="text-center text-white">
            <h1 class="display-5 fw-bold mb-3">{% if is_edit %}Редактировать услугу{% else %}Создать услугу{% endif %}</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb justify-content-center mb-0 breadcrumb-header">
                    <li class="breadcrumb-item">
                        <a href="{% url 'home' %}" class="text-white text-decoration-none">Главная</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'services:service_list' %}" class="text-white text-decoration-none">Услуги</a>
                    </li>
                    <li class="breadcrumb-item active text-white" aria-current="page">{% if is_edit %}Редактировать{% else %}Создать{% endif %}</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="d-flex justify-content-end mb-4">
            <a href="{% url 'services:service_list' %}" class="btn btn-secondary">
                ← Назад к списку
            </a>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label">
                            {{ form.title.label }}
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-danger small mt-1">{{ form.title.errors }}</div>
                        {% endif %}
                        {% if form.title.help_text %}
                            <div class="form-text">{{ form.title.help_text }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            {{ form.description.label }}
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger small mt-1">{{ form.description.errors }}</div>
                        {% endif %}
                        {% if form.description.help_text %}
                            <div class="form-text">{{ form.description.help_text }}</div>
                        {% endif %}
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.section.id_for_label }}" class="form-label">
                                {{ form.section.label }}
                            </label>
                            {{ form.section }}
                            {% if form.section.errors %}
                                <div class="text-danger small mt-1">{{ form.section.errors }}</div>
                            {% endif %}
                            {% if form.section.help_text %}
                                <div class="form-text">{{ form.section.help_text }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.category.id_for_label }}" class="form-label">
                                {{ form.category.label }}
                            </label>
                            {{ form.category }}
                            {% if form.category.errors %}
                                <div class="text-danger small mt-1">{{ form.category.errors }}</div>
                            {% endif %}
                            {% if form.category.help_text %}
                                <div class="form-text">{{ form.category.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label mb-3 d-block">
                            {{ form.location_type.label }}
                        </label>
                        <div class="row g-3">
                            {% for radio in form.location_type %}
                                <div class="col-md-4">
                                    <label class="location-type-radio-card p-3 rounded h-100 d-block mb-0" style="cursor: pointer; display: flex; align-items: flex-start;" for="{{ radio.id_for_label }}">
                                        {{ radio.tag }}
                                        <span class="ms-2 flex-grow-1">
                                            {{ radio.choice_label }}
                                        </span>
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                        {% if form.location_type.errors %}
                            <div class="text-danger small mt-1">{{ form.location_type.errors }}</div>
                        {% endif %}
                        {% if form.location_type.help_text %}
                            <div class="form-text">{{ form.location_type.help_text }}</div>
                        {% endif %}
                    </div>

                    <div class="row mb-3" id="location-fields" style="display: none;">
                        <div class="col-md-6">
                            <label for="{{ form.region.id_for_label }}" class="form-label">
                                {{ form.region.label }}
                            </label>
                            {{ form.region }}
                            {% if form.region.errors %}
                                <div class="text-danger small mt-1">{{ form.region.errors }}</div>
                            {% endif %}
                            {% if form.region.help_text %}
                                <div class="form-text">{{ form.region.help_text }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.city.id_for_label }}" class="form-label">
                                {{ form.city.label }}
                            </label>
                            {{ form.city }}
                            {% if form.city.errors %}
                                <div class="text-danger small mt-1">{{ form.city.errors }}</div>
                            {% endif %}
                            {% if form.city.help_text %}
                                <div class="form-text">{{ form.city.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.price.id_for_label }}" class="form-label">
                                {{ form.price.label }}
                            </label>
                            {{ form.price }}
                            {% if form.price.errors %}
                                <div class="text-danger small mt-1">{{ form.price.errors }}</div>
                            {% endif %}
                            {% if form.price.help_text %}
                                <div class="form-text">{{ form.price.help_text }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.payment_period.id_for_label }}" class="form-label">
                                {{ form.payment_period.label }}
                            </label>
                            {{ form.payment_period }}
                            {% if form.payment_period.errors %}
                                <div class="text-danger small mt-1">{{ form.payment_period.errors }}</div>
                            {% endif %}
                            {% if form.payment_period.help_text %}
                                <div class="form-text">{{ form.payment_period.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>

                    {% if is_edit and form.is_active %}
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.is_active }}
                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                    {{ form.is_active.label }}
                                </label>
                                {% if form.is_active.help_text %}
                                    <div class="form-text">{{ form.is_active.help_text }}</div>
                                {% endif %}
                            </div>
                            {% if form.is_active.errors %}
                                <div class="text-danger small mt-1">{{ form.is_active.errors }}</div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">{% if is_edit %}Сохранить изменения{% else %}Создать услугу{% endif %}</button>
                        <a href="{% if is_edit and service %}{% url 'services:service_detail' service.get_public_slug %}{% else %}{% url 'services:service_list' %}{% endif %}" class="btn btn-secondary">Отмена</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Показываем/скрываем поля региона и города в зависимости от места оказания услуги
        const locationTypeRadios = document.querySelectorAll('input[name="location_type"]');
        const locationFields = document.getElementById('location-fields');
        const regionField = document.getElementById('id_region');
        const cityField = document.getElementById('id_city');

        function toggleLocationFields() {
            const selectedValue = document.querySelector('input[name="location_type"]:checked')?.value;
            if (selectedValue === 'self' || selectedValue === 'customer') {
                locationFields.style.display = 'flex';
                if (regionField) regionField.required = true;
                if (cityField) cityField.required = true;
            } else {
                locationFields.style.display = 'none';
                if (regionField) {
                    regionField.required = false;
                    regionField.value = '';
                }
                if (cityField) {
                    cityField.required = false;
                    cityField.value = '';
                }
            }
        }

        // Инициализация при загрузке страницы
        toggleLocationFields();

        // Обработчик изменения места оказания услуги для всех радиокнопок
        locationTypeRadios.forEach(radio => {
            radio.addEventListener('change', toggleLocationFields);
        });

        // Динамическая загрузка категорий по разделу
        const sectionField = document.getElementById('id_section');
        const categoryField = document.getElementById('id_category');
        const categoryUrl = '{% url "services:get_categories_by_section" %}';
        
        // Сохраняем выбранную категорию при редактировании
        const selectedCategoryId = categoryField.value;

        function loadCategories(sectionId, preserveCategory = false) {
            if (!sectionId) {
                categoryField.innerHTML = '<option value="">Сначала выберите раздел</option>';
                categoryField.disabled = true;
                return;
            }

            categoryField.disabled = true;
            categoryField.innerHTML = '<option value="">Загрузка...</option>';

            fetch(`${categoryUrl}?section_id=${sectionId}`)
                .then(response => response.json())
                .then(data => {
                    categoryField.innerHTML = '<option value="">Выберите категорию</option>';
                    
                    if (data.categories && data.categories.length > 0) {
                        data.categories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.name;
                            // Если сохраняем категорию (при редактировании), устанавливаем её как выбранную
                            if (preserveCategory && selectedCategoryId && String(category.id) === String(selectedCategoryId)) {
                                option.selected = true;
                            }
                            categoryField.appendChild(option);
                        });
                        categoryField.disabled = false;
                    } else {
                        categoryField.innerHTML = '<option value="">Нет доступных категорий</option>';
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке категорий:', error);
                    categoryField.innerHTML = '<option value="">Ошибка загрузки</option>';
                });
        }

        // Обработчик изменения раздела
        sectionField.addEventListener('change', function() {
            loadCategories(this.value, false);
            // Сбрасываем выбранную категорию при смене раздела
            categoryField.value = '';
        });

        // Если раздел уже выбран (при редактировании), загружаем категории с сохранением выбранной
        if (sectionField.value) {
            loadCategories(sectionField.value, true);
        } else {
            categoryField.disabled = true;
        }

        // Динамическая загрузка городов по региону
        const cityUrl = '{% url "services:get_cities_by_region" %}';
        
        // Сохраняем выбранный город при редактировании
        const selectedCityId = cityField ? cityField.value : null;

        function loadCities(regionId, preserveCity = false) {
            if (!regionId || !cityField) {
                if (cityField) {
                    cityField.innerHTML = '<option value="">Сначала выберите регион</option>';
                    cityField.disabled = true;
                }
                return;
            }

            cityField.disabled = true;
            cityField.innerHTML = '<option value="">Загрузка...</option>';

            fetch(`${cityUrl}?region_id=${regionId}`)
                .then(response => response.json())
                .then(data => {
                    cityField.innerHTML = '<option value="">Выберите город</option>';
                    
                    if (data.cities && data.cities.length > 0) {
                        data.cities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city.id;
                            option.textContent = city.name;
                            // Если сохраняем город (при редактировании), устанавливаем его как выбранный
                            if (preserveCity && selectedCityId && String(city.id) === String(selectedCityId)) {
                                option.selected = true;
                            }
                            cityField.appendChild(option);
                        });
                        cityField.disabled = false;
                    } else {
                        cityField.innerHTML = '<option value="">Нет доступных городов</option>';
                    }
                })
                .catch(error => {
                    console.error('Ошибка при загрузке городов:', error);
                    cityField.innerHTML = '<option value="">Ошибка загрузки</option>';
                });
        }

        // Обработчик изменения региона
        if (regionField) {
            regionField.addEventListener('change', function() {
                loadCities(this.value, false);
                // Сбрасываем выбранный город при смене региона
                if (cityField) cityField.value = '';
            });

            // Если регион уже выбран (при редактировании), загружаем города с сохранением выбранного
            if (regionField.value) {
                loadCities(regionField.value, true);
            } else if (cityField) {
                cityField.disabled = true;
            }
        }
    });
</script>
{% endblock %}
